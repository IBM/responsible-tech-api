<!--
Copyright 2020- IBM Inc. All rights reserved

SPDX-License-Identifier: Apache2.0
-->
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>IBM Responsible and Inclusive Technology</title>
<script type="text/javascript" src="js/jquery-3.5.1.min.js"></script>
<script type="text/javascript" src="js/uilogger.js"></script> 
<link type="text/css" rel="stylesheet" href="css/incltech-common.css" media="screen" />
<link rel="icon" href="./favicon.png" type="image/x-icon" />
</head>
<body>

<div id="header">
  <div id="headerTitle">IBM <strong>Responsible and Inclusive Technology</strong></div>
</div>

<div id="privacyNotice">
  <p>
    Dear visitor, we use cookies to remember your preferences and to analyze the usage of this tool, in an anonymous way. 
    Beyond registering visits, this tool also captures mouse and keyboard interaction data with research purposes in mind. 
    If you continue to use this tool, we assume that you are happy with it.
    For more information, check out our <a href="#cookiePolicy" id="cookiePolicyLink">cookie policy</a>.
    If you want to report a bug or request a feature, pelase access our <a href="https://github.com/IBM/responsible-tech-api/issues" target="_blank">github repo and create an issue</a>.
    <br>
    <button id="allowCookies">Ok</button> <button id="denyCookies">No</button>
  <div id="cookiePolicy">
    <h3>Cookie policy</h3>
      <ul>
      <li>In the R&I Card Tool, we use cookies to record game state as pending cards, cards drawn, favorite cards, and skipped cards.</li>
      <li>The types of cookies used are first-party cookies for the game state and third-party cookies for analytics purposes. In addition, the analytics tool we use is managed by our team as well.</li>
      <li>The cookies used here have research purposes in mind, helping us on assessing adoption, and understanding how people use the tool as part of daily activities.</li>
    </ul>
  </div>
  </p>
</div>

<div id="main">
<h1 id="mainTitle">Responsible Tech Cards <a href="#help"><img id="helpIcon" src="images/help.svg" height="25" width="25" alt="Game instructions" /></a></h1>
<div id="instructions">
  <a href="#close" id="closeInstructionsLink"><img id="closeInstructions" src="images/close.svg" alt="Close instructions"/></a>
  <p><strong>Goal:</strong> To help teams become aware of and critical about the multi-stakeholder implications of their work by creating a dedicated space to openly build upon knowledge, discuss issues, identify impacts, and brainstorm solutions in a responsible and inclusive way.</p>
  <ol>
    <li>Choose a topic to think about with the cards.</li>
    <li>Enter players' names, pseudonyms, or initials.</li>
    <li>Select a game mode.</li>
    <li>Click start game.</li>
    <li>One player draws (access key d) or skips (access key s) cards on behalf of all players.</li>
    <li>On your turn, please answer, discuss, or reflect on your card.</li>
    <li>(Optional): Add your thoughts to any card, even when it is not your turn, after the current player is done responding.</li>
    <li>The game can stop at any time.</li>
  </ol>
  <p><strong>Please cite as:</strong> Elsayed-Ali, S., Santana, V. F., Berger, S., Becerra Sandoval, J. C. 2023. Responsible & Inclusive Cards: An Online Card Tool to Promote Critical Reflection in Technology Industry Work Practices. In: Proceedings of the 2023 CHI Conference on Human Factors in Computing Systems. ACM, NY.</p>
  
</div>

<label for="topic" class="hint" title="By yourself: What is a research question, method, or technology you're currently designing, using, or focused on? 
With teammates or colleagues: What is something everyone is working on together (e.g., a strategy, a tool, a project, etc)? 
With clients, partners, or external collaborators: What might be a business opportunity or future engagement involving technology and impacting society? 
With strangers: What might be a well-known or recent use-case involving technology and society?">Session topic:</label>
<input id="topic" name="topic" placeholder="Enter a project, topic, technology, opportunity, use-case, or anything that everyone is working on together" title="" />
 
<label for="player">Player:</label>
<input id="player" name="player" placeholder="Enter a player name, pseudonym, or initials" />
<input type="button" name="addPlayer" id="addPlayer" value="Add player" style="margin-top: 0.5em" />

<div id="playersList"><strong>Players:</strong> <ul id="playersListContent"><li>No players added yet.</li></ul></div>

<label for="mode" class="hint" title="Phase 1: Requires no prior knowledge of responsible & inclusive tech. Can be answered by all research teams.
Phase 2: Requires some additional historical knowledge about the technology & at least some degree of self-reflectivity about potential negative impacts.
Phase 3: Requires more specific knowledge about under considered stakeholders both past, present, future, as well as specific R&I vocabulary.
Phase 4: Taking action. Requires actively thinking through changes in the structure of the team or the research project itself.

History: Topics and questions pertaining to previous iterations of your project or prior technologies/ applications related to your work.
Stakeholders: Topics and questions pertaining to people and entities who influence and are impacted by your work, your project, or the tech you create.
Impact and Outcomes: Topics and questions related to project success, context of use, identifying actual or potential positive and negative consequences, and measuring the effects of your work.
Practices and Actions: Topics and questions related to your work's context of creation and underlying technologies or processes.">Game mode:</label>
<select name="mode" id="mode" style="width: 100%">
  <optgroup label="Phase - all suits included">
    <option value="phase1">Phase 1 (Getting started): 32 cards</option>
    <option value="phase2">Phase 2 (Information gathering): 31 cards</option>
    <option value="phase3">Phase 3 (Going into the specifics): 22 cards</option>
    <option value="phase4">Phase 4 (Call to action): 20 cards</option>
  </optgroup>
  <optgroup label="Suit - phase 1 through phase 4">
    <option value="history">History: 7 cards</option>
    <option value="stakeholder">Stakeholders: 27 cards</option>
    <option value="impact">Impact and Outcomes: 38 cards</option>
    <option value="practices">Practices and Actions: 29 cards</option>    
  </optgroup>
</select>

<input type="button" name="startGame" id="startGame" value="Start game" style="margin-top: 0.5em" disabled="true" disabled />

<button name="drawCard" id="drawCard" accesskey="d" disabled="true" title="Draw card (access key d)" disabled ><span class="accessLetter">D</span>raw card</button>  

<!-- TODO: Add the following info as hint/tooltip for skip button with question mark
Skip card if you or your teammates don't know how to answer the card OR if you think a card is not applicable for the work that you do.
-->
<button name="skipCard" id="skipCard" accesskey="s" disabled="true" title="Skip card (access key s)" disabled><span class="accessLetter">S</span>kip card</button> 

<div id="card" class="flip-card">
    <div class="flip-card-inner">
      <div id="cardFront" class="flip-card-front">
        <h2>R&I Tech Card Game</h2>
        <div id="cardFrontContent"></div>
      </div>
      <div id="cardBack" class="flip-card-back">
        <div id="cardBackContent" contenteditable="true"><strong>Your questions will appear here.</strong></div>
      </div>
    </div>
  </div> 
</div>

<div id="progressBarContainer"><span></span></div>
<div id="progressBar"></div>

<div id="timer">
  <a href="#subtractTime"><img id="timerSubtract" src="./images/alarm--subtract.svg" width="25" alt="Decrease time" /></a>
  <span id="time">00:00</span>
  <a href="#addTime"><img id="timerAdd" src="./images/alarm--add.svg" width="25" alt="Increase time" /></a>
</div>

<div id="printFavorite">
  <a id="printFavoriteLink" href="#print" title="Print favorite questions"><img id="printFavoriteIcon" src="images/printer.svg" height="25" width="25" alt="Print favorite questions" /><span id="favoriteCount">0</span></a>
</div>

<script type="text/javascript"> 
/************************************************************************
 * Utility functions
 ***********************************************************************/ 


/************************
 * Create cookie
 ***********************/ 
function createCookie( name, value, days ){
  var cookie = escape( $.trim( name ) ) + "=" + escape( $.trim( value ) ) + "; SameSite=None; Secure" ; // Session cookie is the default
  if( days ){
    var d = new Date() ;
    d.setDate( d.getDate() + days ) ;
    cookie += ";expires=" + d.toUTCString() ; // Application cookie
  }
  document.cookie = cookie ;
}

/************************
 * Read cookie
 ***********************/
function readCookie( name ){
  var cookies = document.cookie.split( new RegExp( ";", "g" ) ) ;
  for( var i = 0; i < cookies.length; i++ ){
    if( $.trim( cookies[i].split("=")[0] ) == escape( $.trim( name ) ) ){
      return unescape( $.trim( cookies[i].split("=")[1] ) ) ;
    }
  }
  return "" ;  
}

/************************
 * Updating the timer
 ***********************/
var t ; 
var updateTimer = function( deadline, selector ){
  clearInterval( t ) ;
  t = setInterval( function(){
    let delta = deadline - new Date().getTime() ;
    let ss = Math.floor( delta / 1000 ) ;
    ss = ss % 60 ;
    ss < 10 ? ss = "0" + ss: ss ;
    let mm = Math.floor( ( delta / 60 )/ 1000 ) ;
    mm < 10 ? mm = "0" + mm: mm ;
    $( selector ).text( mm + ":" + ss ) ;
    if( delta < 0 ){
      clearInterval( t ) ;
      $( selector ).text( "Time's up!" ) ;
      $( "audio#alarm" )[0].play() ;
    }
  }, 1000 ) ;
};

/************************
 * Load progress bar
 ***********************/
function loadProgressBar(){
  if( readCookie( "size" ) != "" && readCookie( "card" ) != "" ){
    let size = readCookie( "size" ) ;
    let card = readCookie( "card" ) ;
    $( window ).data( "card", card ) ;
    $( window ).data( "size", size ) ;
    updateProgressBar( card, size ) ;
  }
}

/************************
 * Update progress bar
 ***********************/
function updateProgressBar( card, size ){
  let maxWidth = 25 ;
  card = parseInt( card ) ;
  size = parseInt( size ) ;
  if( card == 0 ){
    $( "#progressBar" ).attr( "title", size + " cards left in this game mode"  ) ;
    $( "#progressBar" ).width( "25%" ) ;
    $( "#progressBarContainer span" ).html( size + " cards left in this game mode" ) ;
  }
  else if( card >= size ){        
    $( "#progressBar" ).attr( "title", "0 cards left in this game mode"  ) ;
    $( "#progressBarContainer span" ).html( "0 cards left in this game mode" ) ;
    $( "#progressBar" ).animate( { "width": "0.0%" } ) ;    

    // TODO: Add a conclusion message outside the cards
    // $( "#cardBackContent" ).html( "All cards were used.<br>Thanks for playing!" ) ;
    $( "#cardBackContent" ).triggerHandler( "focus" ) ;
    $( "#drawCard" ).prop( "disabled", true ) ;
    $( "#skipCard" ).prop( "disabled", true ) ;
    $( "#startGame" ).prop( "disabled", false ) ;
    $( "#topic" ).css( "border-bottom-width", "1px" ).css( "background-color", "#f4f4f4" ).css( "font-weight", "normal" )  ;    
  }
  else{
    let w = ( ( size - card ) / size ) * maxWidth ;
    w = w.toFixed(2) ;
    $( "#progressBar" ).animate( { "width": w + "%" } ) ;
    $( "#progressBar" ).attr( "title", ( size - card ) + " cards left in this game mode"  ) ;
    $( "#progressBarContainer span" ).html( ( size - card ) + " cards left in this game mode" ) ;
  }
  createCookie( "size", size, 365 ) ;
  createCookie( "card", card, 365 ) ;
}

/************************
 * Load game state
 ***********************/
function loadGameState(){
  if( readCookie( "topic" ) != "" ){
    $( "#topic" ).prop( "value", readCookie( "topic" ) ) ;
  } 
  
  if( readCookie( "mode" ) != "" ){
    $( "select#mode" ).prop( "value", readCookie( "mode" ) ) ;
  }

  let card = 0 ;
  if( readCookie( "card" ) != "" ){
    card = parseInt( readCookie( "card" ) ) ;
    if( card > 0 ){
      card-- ; // card array is 0 indexed
    }
  }

  // Request questions based on IDs
  let q = "" ;
  if( readCookie( "q" ) != ""  ){
    $( "#cardBackContent" ).html( "" ) ;
    // $.get( "https://brl-rrf.bx.cloud9.ibm.com/uilogger/static/", function( data ){
    //   console.debug( data ) ;
    // }).done( function(){
      q = readCookie( "q" ) ;  // Card ids
      $.get( "/incltech/initgame/" + q, function( data ){ 
      // console.debug( "Requesting card deck" ) ;
      }).done( function( questions ){
        $( window ).data( "q", questions ) ;
        q = questions ;
        if( q[ card ] ){
          var question = q[ card ].text ;
          // Getting content between tags and capitalizing the first letter
          let tag = "<strong>" ;
          let gat = "</strong>" ;
          question = question.substring( question.indexOf( tag ), question.indexOf( gat ) + gat.length ) ;
          question = question.substring( 0, tag.length ) + question.charAt( tag.length ).toUpperCase() + question.substring( tag.length + 1 ) ; 
          // Hidden player name to be read out by screen readers
          let hiddenPlayerName = "<span class='playerName'></span> " ;
          let feedback = "" ;
          if( readCookie( "allowCookies" ) == "true" ){
            feedback = "<div id='feedback'><label>Rate this card (optional):</label><a id='favoriteLink' href='#favorite' title='I found that this card generated valuable conversation, is interesting to think about, or might be good to revisit'><img id='favorite' src='images/face-favorite.svg' alt='Mark this card as favorite.'/></a> <a href='#confusing' id='confusingLink' title='I found this card confusing for any reason'><img id='confusing' src='images/face-confusing.svg' alt='Mark this card as confusing.'/></a></div>" ;
          }
          $( "#cardBackContent" ).html( "<span id='suit'>" + q[ card ].suit + " " + q[ card ].code + "</span><br>" + hiddenPlayerName + question + "<br>" + feedback + "<span id='phase'>Phase " + q[ card ].phase + "</span>" ) ; 
          let cardClass = q[ card ].suit.replaceAll( " ", "-" ) ;
          if( $( "#cardBack" ).hasClass( cardClass ) == false ){
            $( "#cardBack" ).toggleClass( cardClass ) ; // Changing card style based on the suit
          }

          // Hooking custom favorite events
          $( "img#favorite" ).on( 'click', function(){
            var favoriteEvent = jQuery.Event( 'favoritecard' );
            favoriteEvent.info = { "card": $( "#cardBackContent strong" ).html() } ;
            $( "img#favorite" ).trigger( favoriteEvent ) ;
            $( "a#favoriteLink" ).toggleClass( "selected" ) ;
          });
          $( "img#confusing" ).on( 'click', function(){
            var confusingEvent = jQuery.Event( 'confusingcard' );
            confusingEvent.info = { "card": $( "#cardBackContent strong" ).html() } ;
            $( "img#confusing" ).trigger( confusingEvent ) ;
            $( "a#confusingLink" ).toggleClass( "selected" ) ;
          });
        }

        // Loading player names
        // Thus must be done after loading loading questions to ensure accessibility in the card
        let players = "" ;
        if( readCookie( "players" ) != "" && readCookie( "players" ) != "[]" ){
          players = JSON.parse( readCookie( "players" ) ) ;

          $( "#playersList ul" ).html( "" ) ;
          for( i in players ){
            let p = document.createElement( "li" ) ;
            $( p ).text( players[i] ) ;
            $( p ).append( '<a href="#removePlayer" class="removePlayer" title="Remove player"><img src="images/close.svg" alt="Remove player"/></a>' ) ;
            $( "#playersList ul" ).append( p ) ;
          }
          // Remove player functionality
          $( "ul#playersListContent li a" ).on( "click", function(){
            // verify if the removed child is the one playing and set the turn to next one
            // console.debug( $( this ).parent().css( "margin-right" ) ) ;
            if( $( this ).parent().css( "margin-right" ) == "-4em" || $( this ).parent().css( "margin-right" ) == "-64px" ){
              $( this ).parent().next().animate( { marginRight: "-4em", marginLeft: "2em" }, 500 ) ;
            }
            $( this ).parent().remove() ;
            // Registering game state
            if( readCookie( "allowCookies" ) == "true" ){
              saveGameState() ;
            }

            // verify if the removed child is the only one in the list, then return to initial state
            if( $( "#playersList ul" ).html() == "" ){
              $( "#playersList ul" ).html( "<li>No players added yet.</li>" ) ;
              $( "#startGame" ).prop( "disabled", true ) ;
              $( "#drawCard" ).prop( "disabled", true ) ;
              $( "#skipCard" ).prop( "disabled", true ) ;
            }
          });    

          // Setting players turn
          let player = 0 ;  
          if( players.length > 0 ){
            if( readCookie( "player" ) != "" ){
              player = readCookie( "player" ) ;
              if( player >= players.length ){ // Dealing with player exclusion cases
                player = 0 ;
              }
              $( window ).data( "player", player ) ;
            }
            // Showing player to play
            $( "#playersList ul li" ).each( function( index ){
              if( index == player ){
                $( "#cardBackContent span.playerName" ).html( "Player: " + $(this).text() )  ;
                $( "#cardBackContent" ).triggerHandler( "focus" ) ;
                $(this).animate( { marginRight: "-4em", marginLeft: "2em" }, 500 ) ;
              }
            });
          }    
        }
      // Enabling draw and skip button
      $( "#drawCard" ).prop( "disabled", false ) ;
      $( "#skipCard" ).prop( "disabled", false ) ;        

      });
    // }).fail( function(){
    //   $( "#cardBackContent" ).html( "<span id='suit'>Error</span><br>I'm sorry. A problem occurred when loading questions.<br><span id='phase'>Error</span>" ) ; 
    //   $( "#cardBackContent" ).triggerHandler( "focus" ) ;
    // });
    
    // Flip the card
    $( '.flip-card .flip-card-inner ' ).css( 'transform', 'rotateY(180deg)' ) ;
  }

  // Setting progress bar
  loadProgressBar() ;

  // Init favorite question
  if( readCookie( "favoriteCards" ) !=  "" ){
    cards = JSON.parse( readCookie( "favoriteCards" ) ) ;
    $( "span#favoriteCount" ).text( cards.length ) ;
  }

  // Game instructions
  if( readCookie( "instructions" ) !=  "" ){
    if( readCookie( "instructions" ) == "hide" ){
      $("#instructions").css( "display", "none" ) ;
    }
    else{
      $("#instructions").css( "display", "none" ) ;
    }
  }
}

/************************
 * Save game state
 ***********************/
function saveGameState(){
  let topic = $( "#topic" ).prop( "value" ) ;
  let mode = $( "select#mode" ).val() ;
  
  let q = [] ;
  if( $( window ).data( "q" ) != "" ){
    q = $( window ).data( "q" ) ;
  }
  
  let player = 0 ;
  if( $( window ).data( "player" ) != "" ){
    player = $( window ).data( "player" ) ;
  }

  let card = "" ;
  if( $( window ).data( "card" ) != "" ){
    card = $( window ).data( "card" ) ;
  }
  
  let size = "" ; 
  if( $( window ).data( "size" ) != "" ){
    size = $( window ).data( "size" ) ;
  }
  
  // Registering IDs of each card in the deck
  let ids = "" ;
  if( q ){
    if( q.length > 0 ){
      for( i = 0; i < q.length; i++ ){
        if( ids == "" ){
          ids += q[i].id ;
        }
        else{
          ids += "," + q[i].id ;
        }
      }
    }
  }

  // Retrieving players names
  let players = [] ;
  $( "#playersList ul li" ).each( function( index ){
    players.push( this.innerText ) ;
  });

  createCookie( "topic", topic, 365 ) ;
  createCookie( "mode", mode, 365 ) ;
  createCookie( "q", ids, 365 ) ; // Registering IDS due to cookie size restrictions
  createCookie( "card", card, 365 ) ; 
  createCookie( "players", JSON.stringify( players ), 365 ) ;
  createCookie( "player", player, 365 ) ;
  createCookie( "size", size, 365 ) ;
}



/************************************************************************
 * Game mechanics
 ***********************************************************************/

/************************
 * Load timer init
 ***********************/
if( readCookie( "interval" ) == "" ){
  createCookie( "interval", 120, 365 ) ;
}

/************************
 * Creating location map
 ***********************/
location.queryString = {} ;
location.search.substr(1).split( "&" ).forEach( function( pair ){
  if ( pair === "" ) return ;
  var parts = pair.split( "=" ) ;
  location.queryString[ parts[ 0 ] ] = parts[ 1 ] && decodeURIComponent( parts[ 1 ].replace( /\+/g, " " ) ) ;
});

/************************
 * Add player button functionality
 ***********************/
// Adding player on enter
$('input#player').keypress( function( e ){
  if( e.which == 13 ){
    $( "#addPlayer" ).trigger( "click" )  ;         
    return false ;
  }
});

$( "#addPlayer" ).on( "click", function(){
    if( $( "#player" ).val() != "" ){
        if( $( "#playersList ul" ).html() == "<li>No players added yet.</li>" ){
            $( "#playersList ul" ).html( "" ) ;
            $( "#startGame" ).prop( "disabled", false ) ;
        }
        let new_player = document.createElement( "li" ) ;
        $( new_player ).text( $( "#player" ).val() ) ; // ensuring that no html tags are rendered in the players list
        $( new_player ).append( '<a href="#removePlayer" class="removePlayer" title="Remove player"><img src="images/close.svg" alt="Remove player"/></a>' ) ;
        $( "#playersList ul" ).append( new_player ) ;
        $( "#player" ).val( "" ) ;

        // Registering game state
        if( readCookie( "allowCookies" ) == "true" ){
          saveGameState() ;
        }

        // Remove player
        $( "ul#playersListContent li a" ).on( "click", function(){
          // verify if the removed child is the one playing and set the turn to next one
          // console.debug( $( this ).parent().css( "margin-right" ) ) ;
          if( $( this ).parent().css( "margin-right" ) == "-4em" || $( this ).parent().css( "margin-right" ) == "-64px" ){
            $( this ).parent().next().animate( { marginRight: "-4em", marginLeft: "2em" }, 500 ) ;
          }
          $( this ).parent().remove() ;
          // Registering game state
          if( readCookie( "allowCookies" ) == "true" ){
            saveGameState() ;
          }

          // verify if the removed child is the only one in the list, then return to initial state
          if( $( "#playersList ul" ).html() == "" ){
            $( "#playersList ul" ).html( "<li>No players added yet.</li>" ) ;
            $( "#startGame" ).prop( "disabled", true ) ;
            $( "#drawCard" ).prop( "disabled", true ) ;
            $( "#skipCard" ).prop( "disabled", true ) ;
          }
        });
    }
});

/************************
 * Start game button functionality
 ***********************/
$( "#startGame" ).on( "click", function(){
  var interval = parseInt( readCookie( "interval" ) ) ;
  updateTimer( new Date().getTime() + 1000 * interval, "#time" ) ;
  $( "#cardBackContent" ).html( "" ) ;
  $( "#card" ).fadeOut( "slow", function() {
    $( "#card" ).fadeIn( "slow", function(){  
      var gameMode = "" ; // Passing nothing to the API retrieves the process ordered deck (the same as layer1)
      if( location.queryString.cards ){ // Game mode using decks based on core questions
        if( Number.isInteger( Number.parseInt( location.queryString.cards ) ) ){
          gameMode = location.queryString.cards ;
        }
      }
      else{ // Game mode using decks based on layers or suits
        gameMode = $( "select#mode" ).val() ;
        $( "#cardBack" ).addClass( gameMode ) ; // Changing card style based on the phase
      }
      
      // $.get( "https://brl-rrf.bx.cloud9.ibm.com/uilogger/static/", function( data ){
      //   console.debug( data ) ;
      // }).done( function(){
        $.get( "/incltech/initgame/" + gameMode, function( data ){ 
            // console.debug( "Requesting card deck" ) ;
        }).done( function( questions ){
            $( window ).data( "q", questions ) ;
            $( "#startGame" ).prop( "disabled", true ) ;
            $( "#topic" ).css( "border-bottom-width", 0 ).css( "background-color", "#fff" ).css( "font-weight", "bold" )  ;
            $( "#drawCard" ).prop( "disabled", false ) ;
            $( "#skipCard" ).prop( "disabled", false ) ;

            $( window ).data( "player", 0 ) ;
            $( window ).data( "card", 0 ) ;
            $( window ).data( "size", questions.length ) ;

            // Reset positions when the game is restarting
            $( "#playersList ul li" ).each( function( index ){
                $( this ).animate( { marginRight: "0em", marginLeft: "-2em" }, 500 ) ;
            });

            // Registering game state
            if( readCookie( "allowCookies" ) == "true" ){
              saveGameState() ;
            }

            // Highlighting the first player
            $( "#playersList ul li:first" ).animate({ marginRight: "-4em", marginLeft: "2em" }, 500 ) ;
            // Hidden player name to be read out by screen readers
            let hiddenPlayerName = "<span class='playerName'>Player: " + $( "#playersList ul li:first" ).text() + "</span> " ;

            var question = questions[ 0 ].text ; // Picking the card from the pile
            $( window ).data( "card", 1 ) ; // Registering the next card to be used
            // Getting content between tags and capitalizing the first letter
            let tag = "<strong>" ;
            let gat = "</strong>" ;
            question = question.substring( question.indexOf( tag ), question.indexOf( gat ) + gat.length ) ;
            question = question.substring( 0, tag.length ) + question.charAt( tag.length ).toUpperCase() + question.substring( tag.length + 1 ) ;                
            let feedback = "" ;
            if( readCookie( "allowCookies" ) == "true" ){
              feedback = "<div id='feedback'><label>Rate this card (optional):</label><a id='favoriteLink' href='#favorite' title='I found that this card generated valuable conversation, is interesting to think about, or might be good to revisit'><img id='favorite' src='images/face-favorite.svg' alt='Mark this card as favorite.'/></a> <a href='#confusing' id='confusingLink' title='I found this card confusing for any reason'><img id='confusing' src='images/face-confusing.svg' alt='Mark this card as confusing.'/></a></div>" ;
            }
            $( "#cardBackContent" ).html( "<span id='suit'>" + questions[ 0 ].suit + " " + questions[ 0 ].code + "</span><br>" + hiddenPlayerName + question + "<br>" + feedback + "<span id='phase'>Phase " + questions[ 0 ].phase + "</span>" ) ; 
            let cardClass = questions[ 0 ].suit.replaceAll( " ", "-" ) ;
            if( $( "#cardBack" ).hasClass( cardClass ) == false ){
              $( "#cardBack" ).toggleClass( cardClass ) ; // Changing card style based on the suit
            }
            $( "#cardBackContent" ).triggerHandler( "focus" ) ;

            // Hooking custom events
            $( "img#favorite" ).on( 'click', function(){
              var favoriteEvent = jQuery.Event( 'favoritecard' );
              favoriteEvent.info = { "card": $( "#cardBackContent strong" ).html() } ;
              $( "img#favorite" ).trigger( favoriteEvent ) ;
              $( "a#favoriteLink" ).toggleClass( "selected" ) ;
            });
            $( "img#confusing" ).on( 'click', function(){
              var confusingEvent = jQuery.Event( 'confusingcard' );
              confusingEvent.info = { "card": $( "#cardBackContent strong" ).html() } ;
              $( "img#confusing" ).trigger( confusingEvent ) ;
              $( "a#confusingLink" ).toggleClass( "selected" ) ;
            });
            
            // Hiding instructions in case they are opened
            if( $("#instructions").css( "display" ) !== 'none' ){
              $("#instructions").slideToggle( "slow" ) ;
              
            }

            updateProgressBar( $( window ).data( "card" ), $( window ).data( "size" ) ) ;
        });
      // }).fail( function(){
      //   $( "#cardBackContent" ).html( "<span id='suit'>Error</span><br>I'm sorry. A problem ocurred when loading questions.<br><span id='phase'>Error</span>" ) ; 
      //   $( "#cardBackContent" ).triggerHandler( "focus" ) ;
      // });
    });
  });

  // Flip the card
  $( '.flip-card .flip-card-inner ' ).css( 'transform', 'rotateY(180deg)' ) ;

} ) ;

/************************
 * Draw card button functionality
 ***********************/
$( "#drawCard" ).on( "click", function(){
  var interval = parseInt( readCookie( "interval" ) ) ;
  updateTimer( new Date().getTime() + 1000 * interval, "#time" ) ;
  $( "#cardBackContent" ).html( "" ) ;
  $( "#card" ).fadeOut( "slow", function() {
    $( "#card" ).fadeIn( "slow", function(){
      var player = $( window ).data( "player" ) ;
      var card = $( window ).data( "card" ) ;
      var q = $( window ).data( "q" ) ;
      if( q[ card ] ){
        var question = q[ card ].text ;
        // Getting content between tags and capitalizing the first letter
        let tag = "<strong>" ;
        let gat = "</strong>" ;
        question = question.substring( question.indexOf( tag ), question.indexOf( gat ) + gat.length ) ;
        question = question.substring( 0, tag.length ) + question.charAt( tag.length ).toUpperCase() + question.substring( tag.length + 1 ) ; 
        // Hidden player name to be read out by screen readers
        let hiddenPlayerName = "<span class='playerName'></span> " ;
        let feedback = "" ;
        if( readCookie( "allowCookies" ) == "true" ){
          feedback = "<div id='feedback'><label>Rate this card (optional):</label><a id='favoriteLink' href='#favorite' title='I found that this card generated valuable conversation, is interesting to think about, or might be good to revisit'><img id='favorite' src='images/face-favorite.svg' alt='Mark this card as favorite.'/></a> <a href='#confusing' id='confusingLink' title='I found this card confusing for any reason'><img id='confusing' src='images/face-confusing.svg' alt='Mark this card as confusing.'/></a></div>" ;
        }
        $( "#cardBackContent" ).html( "<span id='suit'>" + q[ card ].suit + " " + q[ card ].code + "</span><br>" + hiddenPlayerName + question + "<br>" + feedback + "<span id='phase'>Phase " + q[ card ].phase + "</span>" ) ; 
        let cardClass = q[ card ].suit.replaceAll( " ", "-" ) ;
        if( $( "#cardBack" ).hasClass( cardClass ) == false ){
          $( "#cardBack" ).toggleClass( cardClass ) ; // Changing card style based on the suit
        }
        $( window ).data( "card", ++card ) ;

        // Hooking custom favorite events
        $( "img#favorite" ).on( 'click', function(){
          var favoriteEvent = jQuery.Event( 'favoritecard' );
          favoriteEvent.info = { "card": $( "#cardBackContent strong" ).html() } ;
          $( "img#favorite" ).trigger( favoriteEvent ) ;
          $( "a#favoriteLink" ).toggleClass( "selected" ) ;
        });
        $( "img#confusing" ).on( 'click', function(){
          var confusingEvent = jQuery.Event( 'confusingcard' );
          confusingEvent.info = { "card": $( "#cardBackContent strong" ).html() } ;
          $( "img#confusing" ).trigger( confusingEvent ) ;
          $( "a#confusingLink" ).toggleClass( "selected" ) ;
        });

        // Triggering custom drawcard event
        var event = jQuery.Event( 'drawcard' );
        event.info = { "card": $( "#cardBackContent strong" ).html() } ;
        $( this ).trigger( event ) ;

        // Resetting players list
        $( "#playersList ul li" ).each( function( index ){
          if( index == player ){
            $(this).animate( { marginRight: "0em", marginLeft: "-2em" }, 500 ) ;
          }
        });
        player++ ;
        var players = $('#playersList ul li').length ;
        player = player % players ;
        $( window ).data( "player", player ) ;

        // Showing player to play
        $( "#playersList ul li" ).each( function( index ){
          if( index == player ){
            $( "#cardBackContent span.playerName" ).html( "Player: " + $(this).text() )  ;
            $( "#cardBackContent" ).triggerHandler( "focus" ) ;
            $(this).animate( { marginRight: "-4em", marginLeft: "2em" }, 500 ) ;
          }
        });
      }
      else{
        // TODO: Add a conclusion message outside the cards
        // $( "#cardBackContent" ).html( "All cards were used.<br>Thanks for playing!" ) ;
        $( "#cardBackContent" ).triggerHandler( "focus" ) ;
        // TODO: store favorite cards and show them when the game is finished
        $( "#drawCard" ).prop( "disabled", true ) ;
        $( "#skipCard" ).prop( "disabled", true ) ;
        $( "#startGame" ).prop( "disabled", false ) ;
        $( "#topic" ).css( "border-bottom-width", "1px" ).css( "background-color", "#f4f4f4" ).css( "font-weight", "normal" )  ;
        $( window ).data( "card", ++card ) ;
      }

      // Updating the progress bar
      updateProgressBar( card, $( window ).data( "size" ) ) ;

      // Flip the card
      $( '.flip-card .flip-card-inner' ).css( 'transform', 'rotateY(180deg)' ) ;

      // Registering game state
      if( readCookie( "allowCookies" ) == "true" ){
        saveGameState() ;
      }
    });
  });
});

/************************
 * Skip card button functionality
 ***********************/
$( "#skipCard" ).on( "click", function(){
  var interval = parseInt( readCookie( "interval" ) ) ;
  updateTimer( new Date().getTime() + 1000 * interval, "#time" ) ;
  
  // Triggering custom skipcard event
  var event = jQuery.Event( 'skipcard' );
  event.info = { "card": $( "#cardBackContent strong" ).html() } ;
  $( this ).trigger( event ) ;  

  $( "#cardBackContent" ).html( "" ) ;
  $( "#card" ).fadeOut( "slow", function() {
    $( "#card" ).fadeIn( "slow", function(){
      var player = $( window ).data( "player" ) ;
      var card = $( window ).data( "card" ) ;
      var q = $( window ).data( "q" ) ;
      if( q[ card ] ){
        var question = q[ card ].text ;
        // Getting content between tags and capitalizing the first letter
        let tag = "<strong>" ;
        let gat = "</strong>" ;
        question = question.substring( question.indexOf( tag ), question.indexOf( gat ) + gat.length ) ;
        question = question.substring( 0, tag.length ) + question.charAt( tag.length ).toUpperCase() + question.substring( tag.length + 1 ) ; 
        // Hidden player name to be read out by screen readers
        let hiddenPlayerName = "<span class='playerName'>Player: " + $( "#playersList ul li:nth-child(" + ( player + 1 ) + ")" ).text() + "</span> " ;
        let feedback = "" ;
        if( readCookie( "allowCookies" ) == "true" ){
          feedback = "<div id='feedback'><label>Rate this card:</label><a id='favoriteLink' href='#favorite'><img id='favorite' src='images/face-favorite.svg' alt='Mark this card as favorite.'/></a> <a href='#confusing' id='confusingLink'><img id='confusing' src='images/face-confusing.svg' alt='Mark this card as confusing.'/></a></div>" ;
        }
        $( "#cardBackContent" ).html( "<span id='suit'>" + q[ card ].suit + " " + q[ card ].code + "</span><br>" + hiddenPlayerName + question + "<br>" + feedback + "<span id='phase'>Phase " + q[ card ].phase + "</span>" ) ; 
        $( "#cardBackContent" ).triggerHandler( "focus" ) ;
        let cardClass = q[ card ].suit.replaceAll( " ", "-" ) ;
        if( $( "#cardBack" ).hasClass( cardClass ) == false ){
          $( "#cardBack" ).toggleClass( cardClass ) ; // Changing card style based on the suit
        }

        // Hooking custom favorite/confusing events
        $( "img#favorite" ).on( 'click', function(){
          var favoriteEvent = jQuery.Event( 'favoritecard' );
          favoriteEvent.info = { "card": $( "#cardBackContent strong" ).html() } ;
          $( "img#favorite" ).trigger( favoriteEvent ) ;
          $( "a#favoriteLink" ).toggleClass( "selected" ) ;
        });
        $( "img#confusing" ).on( 'click', function(){
          var confusingEvent = jQuery.Event( 'confusingcard' );
          confusingEvent.info = { "card": $( "#cardBackContent strong" ).html() } ;
          $( "img#confusing" ).trigger( confusingEvent ) ;
          $( "a#confusingLink" ).toggleClass( "selected" ) ;
        });

        $( window ).data( "card", ++card ) ;
      }
      else{
        // TODO: Add a conclusion message outside the cards
        // $( "#cardBackContent" ).html( "All cards were used.<br>Thanks for playing!" ) ;
        $( "#cardBackContent" ).triggerHandler( "focus" ) ;
        $( "#drawCard" ).prop( "disabled", true ) ;
        $( "#skipCard" ).prop( "disabled", true ) ;
        $( "#startGame" ).prop( "disabled", false ) ;
        $( "#topic" ).css( "border-bottom-width", "1px" ).css( "background-color", "#f4f4f4" ).css( "font-weight", "normal" )  ;
        $( window ).data( "card", ++card ) ;
      }

      // Updating the progress bar
      updateProgressBar( card, $( window ).data( "size" ) ) ;
    });
  });
  // Flip the card
  $( '.flip-card .flip-card-inner' ).css( 'transform', 'rotateY(180deg)' ) ;

  // Registering game state
  if( readCookie( "allowCookies" ) == "true" ){
    saveGameState() ;
  }
});

/************************
 * Help
 ***********************/
// $("#instructions").toggle();
$("#helpIcon, #closeInstructionsLink").on("click", function(){
  $("#instructions").slideToggle("hide");
  if( readCookie( "allowCookies" ) == "true" ){
    createCookie( "instructions", "hide" ) ;
  }
});

/************************
 * Adjusting font-size according to card content length
 ***********************/
var cardObserver = new MutationObserver( function( mutations ){
  let cardContent = mutations[0].target.innerHTML ;
  let question = cardContent.substring( cardContent.indexOf( "<strong>" ), cardContent.indexOf( "</strong>" ) ) ;
  if( question.length > 200 ){
    $( mutations[0].target ) > $( "strong" ).css( "font-size", "0.8em" ) ;
  }
  else if( question.length > 150 ){
    $( mutations[0].target ) > $( "strong" ).css( "font-size", "1em" ) ;
  }
  else if( question.length > 100 ){
    $( mutations[0].target ) > $( "strong" ).css( "font-size", "1.1em" ) ;
  }
  else{
    $( mutations[0].target ).css( "font-size", "1.3em" ) ;
  }
});
var cardObserverConfig = {  attributes: true,  childList: true, characterData: true };
cardObserver.observe( $( "#cardBackContent" )[0], cardObserverConfig ) ;

/************************
 * Allowing players to change the game mode
 ***********************/
$( "#mode" ).on( "change", function(){
  if( $( "#playersList ul" ).html() != "<li>No players added yet.</li>" ){
    $( "#startGame" ).prop( "disabled", false ) ;
  }
} ) ;

/************************
 * Allowing topic to be changed during the game
 ***********************/
$( "#topic" ).on( "focus", function(){
  $( "#topic" ).css( "border-bottom-width", "1px" ).css( "background-color", "#f4f4f4" ).css( "font-weight", "normal" )  ;
});
$( "#topic" ).on( "blur", function(){
  $( "#topic" ).css( "border-bottom-width", 0 ).css( "background-color", "#fff" ).css( "font-weight", "bold" )  ;
  createCookie( "topic", $( "#topic" ).prop( "value" ) ) ;
});  

/************************
 * Init time
 ***********************/
$( "#time" ).text( function(){
  var interval = parseInt( readCookie( "interval" ) ) ;
  let ss = interval % 60 ;
  ss < 10 ? ss = "0" + ss: ss ;
  let mm = Math.floor( interval / 60 ) ;
  mm < 10 ? mm = "0" + mm: mm ;
  return mm + ":" + ss ;
});

/************************
 * Subtract time
 ***********************/
$( "#timerSubtract" ).on( "click", function(){
  var interval = parseInt( readCookie( "interval" ) ) ;
  if( interval > 60 ){
    interval -= 60 ;
  }
  createCookie( "interval", interval ) ; // updating value
  let ss = interval % 60 ;
  ss < 10 ? ss = "0" + ss: ss ;
  let mm = Math.floor( interval / 60 ) ;
  mm < 10 ? mm = "0" + mm: mm ;
  $( "span#time" ).text( mm + ":" + ss ) ;  
  console.debug( mm + ":" + ss )  ;
  // Updating timer only if the game is running 
  if( $( window ).data( "player" ) >= 0 && $( window ).data( "card" ) >= 0 ){
    updateTimer( new Date().getTime() + 1000 * interval, "#time" ) ;
  }
});

/************************
 * Add time
 ***********************/
$( "#timerAdd" ).on( "click", function(){
  var interval = parseInt( readCookie( "interval" ) ) ;
  if( interval < 600 ){
    interval += 60 ;
  }
  createCookie( "interval", interval ) ; // updating value
  let ss = interval % 60 ;
  ss < 10 ? ss = "0" + ss: ss ;
  let mm = Math.floor( interval / 60 ) ;
  mm < 10 ? mm = "0" + mm: mm ;
  $( "span#time" ).text( mm + ":" + ss ) ;  
  console.debug( mm + ":" + ss )  ;
  // Updating timer only if the game is running 
  if( $( window ).data( "player" ) >= 0 && $( window ).data( "card" ) >= 0 ){
    updateTimer( new Date().getTime() + 1000 * interval, "#time" ) ;
  }
});

/************************
 * Recording favorite cards
 ***********************/
$( window ).on( 'favoritecard', function( event ){
  var cards = [] ;
  if( readCookie( "favoriteCards" ) !=  "" ){
    cards = JSON.parse( readCookie( "favoriteCards" ) ) ;
  }
  let cardsHash = []
  for( i in cards ){
    cardsHash[ cards[i].card ] = true ;
  }
  if( cardsHash[ event.info.card ] == undefined || cardsHash[ event.info.card ] == null ){
    cards.push( event.info ) ;  
  }
  $( "span#favoriteCount" ).text( cards.length ) ;
  createCookie( "favoriteCards", JSON.stringify( cards ) ) ;
});

/************************
 * Print favorite cards
 ***********************/
$("#printFavoriteLink").on("click", function(){
  if( readCookie( "favoriteCards" ) !=  "" ){
    var cards = JSON.parse( readCookie( "favoriteCards" ) ) ;
    outContent = "" ;
    outContent += "<!doctype html><head><style type='text/css'>" ;
    outContent += "div.cardFront { font-family: 'IBM Plex Sans', 'Helvetica Neue', sans-serif; width: 6cm; height: 9cm; vertical-align: middle; display: inline-block; background-color: #34bc6e; border-radius: 0.5cm; padding: 0.5cm; margin: 0.2cm; color: #fff; text-align: center; font-weight: bold; word-wrap: break-word; border: 2pt dashed black; }" ;
    outContent += "div.cardBack { font-family: 'IBM Plex Sans', 'Helvetica Neue', sans-serif; width: 6cm; height: 9cm; vertical-align: middle; display: inline-block; background-color: #5392ff; border-radius: 0.5cm; padding: 0.5cm; margin: 0.2cm; color: #fff; text-align: center; font-weight: bold; word-wrap: break-word; background-image: url('https://incltech.mybluemix.net/static/images/card_game-logo.png'); background-position: center center; background-repeat: no-repeat; border: 2pt dashed black; }" ;    
    outContent += "</style></head><body>" ;
    let inlineStyle ;
    for( let i = 0; i < cards.length; i++ ){
      if( cards[i].card.length > 200 ){
        inlineStyle = "font-size: 10pt" ;
      }
      else if( cards[i].card.length > 150 ){
        inlineStyle = "font-size: 12pt" ;
      }
      else if( cards[i].card.length > 100 ){
        inlineStyle = "font-size: 14pt" ;
      }
      else{
        inlineStyle = "font-size: 16pt" ;
      }
      outContent += "<div class='cardFront' style='" + inlineStyle + "'>" + cards[i].card + "</div>" ;
      // printWindow.document.write( "<div class='cardBack'></div>" ) ;
    }
    outContent += "</body></html>" ;
    var printWindow = window.open( "", "print" ) ;
    printWindow.document.write( outContent ) ;
    // printWindow.print() ;
    // printWindow.close() ;
  }  
});

/************************
 * Cookie Policy and privacy
 ***********************/
$( "#cookiePolicy" ).toggle() ;
$( "#cookiePolicyLink" ).on( "click", function(){
  $( "#cookiePolicy" ).slideToggle() ;
});
if( readCookie( "allowCookies" ) == "true" ){
  $( "#privacyNotice" ).toggle() ;
}

/************************
 * Cookies allowed
 ***********************/
$( "#allowCookies" ).on( "click", function(){
  // Flag
  createCookie( "allowCookies", "true", 365 ) ;
  $( "#privacyNotice" ).toggle() ;
  // Logging code
  $(window).uilogger( { userId : '', server : 'https://brl-rrf.bx.cloud9.ibm.com/uilogger/record/', onlyID : true, ajaxType : 'POST', include: 'drawcard.uilogger skipcard.uilogger favoritecard.uilogger confusingcard.uilogger' } ) ; 
});

/************************
 * Cookies denied
 ***********************/
$( "#denyCookies" ).on( "click", function(){
  $( "#privacyNotice" ).toggle() ;
});

/************************
 * Init
 ***********************/
if( readCookie( "allowCookies" ) == "true" ){
  // Loading game state (if any)
  loadGameState() ;
  // Logging code
  $(window).uilogger( { userId : '', server : 'https://brl-rrf.bx.cloud9.ibm.com/uilogger/record/', onlyID : true, ajaxType : 'POST', include: 'drawcard.uilogger skipcard.uilogger favoritecard.uilogger confusingcard.uilogger' } ) ; 
}
</script>
<audio id="alarm"><source src="sounds/happy_bell.wav" type="audio/wav"></audio> 
</body>
</html>
